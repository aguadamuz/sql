--new tagging lists
--all en-US petitions with >= 50 tags
--and < 5 tags
--including collage reccomendations

--undertagged petitions
with collage as
(select petition_id, listagg(name, ' | ') within group (order by name) AS tags
FROM (select ct.petition_id, ct.tag_id, t.name from collage_tags ct join tags t on ct.tag_id = t.id)
GROUP BY 1)
, petition_details as
(
select distinct tgs.taggable_id, tgs.created_at::date as tagged_date, tgs.tag_id, t.name, e.created_at::date, e.total_signature_count, e.created_locale
from taggings tgs
join events e on e.id = tgs.taggable_id
left join collage c on e.id = c.petition_id
left join tags t on tgs.tag_id = t.id
order by taggable_id DESC
)
, tag_details as
(select taggable_id, listagg(name, ' | ') within group (order by name) AS tags
FROM (select pd.taggable_id, pd.tag_id, pd.name from petition_details pd join tags t on pd.tag_id = t.id)
GROUP BY 1)
, tag_details_two as
(select taggable_id, count(distinct tag_id) as tag_count from taggings group by 1)
--
select distinct e.id, coalesce(e.title, e.ask), e.total_signature_count, c.tags as collage_recommendation, td.tags as tags_on_petition, tdt.tag_count
from events e
left join collage c on e.id = c.petition_id
left join tag_details td on e.id = td.taggable_id
left join tag_details_two tdt on e.id = tdt.taggable_id
left join taggings tgs on e.id = tgs.taggable_id
where e.total_signature_count >= 50
and tdt.tag_count < 5
and e.created_locale = 'en-US'
and e.deleted_at is null
and e.status > 0
and e.id not in
(7196381, 7188041, 7011104, 3536281, 7184015, 7002158, 6948167, 6908477, 802085, 1382582, 1439067, 1328024, 951187, 326678, 556473, 1321973, 968137, 1427522, 3722112, 923605, 2771861, 1394598, 1156045, 141033, 484487, 4424824, 1094572, 2292806, 1884170, 235576, 1449614, 1411238, 1323982, 1401217, 2893311, 691704, 474515, 6861020, 2716221, 1345715, 1372960, 1061338, 217578, 1111008, 3629602, 1037515, 1042341, 1099998, 1240473, 300751, 1307386, 1168270, 2998891, 158526, 1184322, 324798, 1212156, 1292298, 1386212, 230053, 1386119, 1044254, 1502346, 1112327, 925787, 1080725, 1484402, 386677, 655686, 1429370, 826986, 1633010, 788120, 3408829, 1405558, 248173, 875725, 303762, 5668122, 1525920, 1440060, 914232, 3442901, 2470196, 7123340, 1379695, 1965515, 2172144, 1315129, 1806655, 1352266, 2359561, 1226303, 2266446, 848344, 2195419, 1441075, 1139339, 1105145, 2770051, 2842611, 982618, 4009336, 3120536, 3104386, 7120739, 1383887, 3638060, 1070024, 798182, 1579295, 1102126, 2353371, 1492587, 3345331, 1327261, 1071412, 2197134, 1062712, 466804, 131848, 2301946, 797686, 1460255, 1138104, 1374067, 298863, 3895664, 1628435, 4856098, 1108334, 1856130, 4417020, 6606995, 1378610, 253301, 2871311, 849073, 919187, 1329280, 7197920)
order by e.total_signature_count desc
LIMIT 100000;

--untagged_petitions
with collage as
(select petition_id, listagg(name, ' | ') within group (order by name) AS tags
FROM (select ct.petition_id, ct.tag_id, t.name from collage_tags ct join tags t on ct.tag_id = t.id)
GROUP BY 1)
, petition_details as
(
select distinct tgs.taggable_id, tgs.created_at::date as tagged_date, tgs.tag_id, t.name, e.created_at::date, e.total_signature_count, e.created_locale
from taggings tgs
join events e on e.id = tgs.taggable_id
left join collage c on e.id = c.petition_id
left join tags t on tgs.tag_id = t.id
order by taggable_id DESC
)
, tag_details as
(select taggable_id, listagg(name, ' | ') within group (order by name) AS tags
FROM (select pd.taggable_id, pd.tag_id, pd.name from petition_details pd join tags t on pd.tag_id = t.id)
GROUP BY 1)
, tag_details_two as
(select taggable_id, count(distinct tag_id) as tag_count from taggings group by 1)
--
select distinct e.id, coalesce(e.title, e.ask), e.total_signature_count, c.tags as collage_recommendation, td.tags as tags_on_petition, tdt.tag_count
from events e
left join collage c on e.id = c.petition_id
left join tag_details td on e.id = td.taggable_id
left join tag_details_two tdt on e.id = tdt.taggable_id
left join taggings tgs on e.id = tgs.taggable_id
where e.total_signature_count >= 50
and tdt.tag_count is null
and e.created_locale = 'en-US'
and e.deleted_at is null
and e.status > 0
and e.id not in 
(4599960, 1711545, 3372221, 1303111, 1220225, 1170248, 2294691, 1345241, 952327, 2183604, 1398661, 4731518, 5741818, 1453124, 2305861, 1509132, 4499494, 971724, 876860, 1775085, 1551785, 1013462, 2848346, 1321149, 250747, 6863156, 4417452, 1109733, 4351092, 6793487, 1343917, 1449063, 4357956, 3045886, 1974165, 1300478, 6433433, 2208839, 1154919, 5556110, 1270712, 4500428, 1480721, 6734738, 1302515, 6496709, 1504131, 1188452, 6787808, 6548987, 6545567, 2877641, 3115176, 3475285, 1447480, 1311942, 1095943, 2158124, 3066751, 5249262, 1369457, 1303117, 1909210, 3912048, 2161284, 4819438, 4417984, 2986896, 1498751, 1914765, 1565490, 1900995, 1579595, 4707462, 1756675, 3024516, 1625965, 5194210, 3879132, 4897526, 3960980, 3278526, 4371483, 3524753, 2047275, 1050234, 1275164, 3075976, 6852545, 4350180, 4048320, 5264034, 6656930, 2243609, 3677367, 3540629, 1451006, 1191439, 2303841, 4735334, 3706199, 3352436, 3602991, 4803578, 1122622, 2936401, 2249049, 6830378, 3930196, 1422186, 3276801, 2109049, 3185291, 3392117, 3492485, 5104486, 3452017, 6345623, 4351256, 3649105, 3347901, 4666786, 6746471, 1436897, 1083612, 4181140, 4365567, 4647470, 4332028, 5554090, 6936827, 2427256, 3280101, 5233066, 898610, 6796961, 1066917, 1573200, 4511039, 1434761, 1549290, 1494393, 1171854, 3015861, 803850, 955509, 1381958, 327540, 59760, 1389723, 1042490, 230989, 271173, 2008950, 2262926, 3375989, 2454336, 1110611, 2172389, 1975200, 1168261, 1380540, 1781055, 930395, 1447843, 1106498, 1259144, 1577735, 1480842, 1432010, 262786, 921049, 1192202, 1468296, 2658106, 1336383, 1337961, 1462112, 71540, 1426472, 1452364, 801744, 1456599, 260928, 1500605, 4017188, 4872062, 1340165, 1449584, 1823825, 1236603, 1523552, 1548020, 1493698, 41262, 2378121, 41966, 1194763, 74466, 4506435, 540794, 1173166, 454212, 446020, 844427, 986540, 1183541, 656963, 1108021, 2678176, 899457, 1355647, 5961710, 1843705, 1352356, 1377947, 1119772, 1355732, 1157072, 1262819, 1068515, 5586074, 5155334, 1426993, 1242292, 1458808, 1375259, 3530213, 1840070, 4422052, 1309893, 1872040, 1355304, 1319112, 1364019, 1068208, 4186232, 883193, 1000383, 1239029, 1220660, 5706218, 1406558, 3071036, 1052346, 3719991, 1339966, 6517406, 1375454, 3940304, 1964925, 4963338, 3062966, 4122356, 1392565, 5236994, 3156331, 268223, 1419292, 735344, 47631, 5620970, 353141, 1392784, 842350, 3733355, 1116263, 153952, 1724690, 4452144, 405208, 271340, 1870390, 1223476, 1306456, 524000, 659394, 1071285, 6281282, 291181, 1244205, 4186372, 498144, 1269246, 1716175, 1382304, 1357788, 797692, 1356642, 6438284, 898896, 1307606, 1373405, 1142131, 38515, 3155716, 3878892, 1477621, 1060342, 1064448, 1108436, 1330810, 39605, 936107, 3350781, 2981376, 3378053, 205070, 6496472, 717502, 183167, 186812, 655990, 177992, 6666521, 1136519, 2622786, 1512658, 62040, 1397755, 88117, 2722101, 5459682, 1366181, 1079246, 867958, 2660246, 2984806, 3576003, 6402815, 4212824, 1450932, 667168)
and e.id not in
(7196381, 7188041, 7011104, 3536281, 7184015, 7002158, 6948167, 6908477, 802085, 1382582, 1439067, 1328024, 951187, 326678, 556473, 1321973, 968137, 1427522, 3722112, 923605, 2771861, 1394598, 1156045, 141033, 484487, 4424824, 1094572, 2292806, 1884170, 235576, 1449614, 1411238, 1323982, 1401217, 2893311, 691704, 474515, 6861020, 2716221, 1345715, 1372960, 1061338, 217578, 1111008, 3629602, 1037515, 1042341, 1099998, 1240473, 300751, 1307386, 1168270, 2998891, 158526, 1184322, 324798, 1212156, 1292298, 1386212, 230053, 1386119, 1044254, 1502346, 1112327, 925787, 1080725, 1484402, 386677, 655686, 1429370, 826986, 1633010, 788120, 3408829, 1405558, 248173, 875725, 303762, 5668122, 1525920, 1440060, 914232, 3442901, 2470196, 7123340, 1379695, 1965515, 2172144, 1315129, 1806655, 1352266, 2359561, 1226303, 2266446, 848344, 2195419, 1441075, 1139339, 1105145, 2770051, 2842611, 982618, 4009336, 3120536, 3104386, 7120739, 1383887, 3638060, 1070024, 798182, 1579295, 1102126, 2353371, 1492587, 3345331, 1327261, 1071412, 2197134, 1062712, 466804, 131848, 2301946, 797686, 1460255, 1138104, 1374067, 298863, 3895664, 1628435, 4856098, 1108334, 1856130, 4417020, 6606995, 1378610, 253301, 2871311, 849073, 919187, 1329280, 7197920)
order by e.total_signature_count desc
LIMIT 100000;

--I need to run the language exclusion python script on the output of the above query to filter out non-English petitions with an en-US created_locale